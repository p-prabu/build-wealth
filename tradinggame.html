<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIFTY 50 Trader Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .price-up { color: #10b981; animation: flash-green 1s; }
        .price-down { color: #ef4444; animation: flash-red 1s; }

        @keyframes flash-green {
            0% { background-color: rgba(16, 185, 129, 0.2); }
            100% { background-color: transparent; }
        }
        @keyframes flash-red {
            0% { background-color: rgba(239, 68, 68, 0.2); }
            100% { background-color: transparent; }
        }
        
        /* Input Focus Ring removal for cleaner look */
        input:focus { outline: none; border-color: #3b82f6; }

        /* REPORT STYLES (Adjusted for PDF generation) */
        #printable-report {
            background: white;
            color: black;
            padding: 40px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="bg-gray-800 border-b border-gray-700 p-4 shadow-md z-10">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-bold text-white">N</div>
                    <div class="flex flex-col">
                        <span class="text-xs text-gray-400">Welcome, Trader</span>
                        <input type="text" id="trader-name" value="Guest" class="bg-transparent border-b border-gray-600 text-lg font-bold text-white w-32 focus:border-blue-500 transition-colors" placeholder="Your Name">
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-6">
                <!-- Download PDF Button -->
                <button onclick="downloadPDF()" class="flex items-center gap-2 text-gray-400 hover:text-white transition group" title="Download Performance Report">
                    <div class="p-2 bg-gray-700 rounded-lg group-hover:bg-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </div>
                    <span class="text-xs font-bold uppercase hidden sm:block">Download PDF</span>
                </button>

                <!-- Wallet Input Section -->
                <div class="flex items-end gap-3 bg-gray-900 p-2 rounded-lg border border-gray-700">
                    <div class="flex flex-col">
                        <label class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Add Funds</label>
                        <div class="flex items-center text-gray-400">
                            <span class="mr-1">₹</span>
                            <input type="number" id="fund-amount" class="bg-transparent w-24 text-sm font-mono text-white placeholder-gray-600" placeholder="50000">
                        </div>
                    </div>
                    <button onclick="addFunds()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-bold transition shadow-lg h-8">
                        ADD
                    </button>
                </div>

                <!-- Wallet Display -->
                <div class="flex flex-col items-end pl-4 border-l border-gray-700">
                    <span class="text-xs text-gray-400 uppercase">Wallet Balance</span>
                    <span class="text-xl font-bold text-green-400">₹<span id="wallet-balance">0.00</span></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left Panel: Market (Stock List) -->
        <div class="w-2/3 flex flex-col border-r border-gray-700">
            <div class="p-4 bg-gray-800 border-b border-gray-700 flex justify-between items-center">
                <h2 class="font-semibold text-lg flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    Live Market
                </h2>
                <div class="text-xs text-yellow-500 bg-yellow-900/30 px-2 py-1 rounded border border-yellow-700/50">
                    ⚠️ Simulating Live Prices (Demo)
                </div>
            </div>

            <!-- Stocks Header -->
            <div class="grid grid-cols-12 gap-4 p-3 text-xs font-semibold text-gray-400 bg-gray-800/50 border-b border-gray-700">
                <div class="col-span-4">COMPANY</div>
                <div class="col-span-3 text-right">PRICE</div>
                <div class="col-span-2 text-right">CHANGE</div>
                <div class="col-span-3 text-center">ACTION</div>
            </div>

            <!-- Scrollable Stock List -->
            <div id="stock-list" class="overflow-y-auto flex-1 bg-gray-900 pb-20">
                <!-- Stocks will be injected here via JS -->
            </div>
        </div>

        <!-- Right Panel: Portfolio & Stats -->
        <div class="w-1/3 flex flex-col bg-gray-850">
            <!-- Portfolio Summary -->
            <div class="p-6 bg-gray-800 border-b border-gray-700 shadow-sm">
                <h2 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-4">Your Portfolio</h2>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                        <div class="text-xs text-gray-400">Invested</div>
                        <div class="text-lg font-bold text-white">₹<span id="total-invested">0.00</span></div>
                    </div>
                    <div class="bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                        <div class="text-xs text-gray-400">Current Value</div>
                        <div class="text-lg font-bold text-white">₹<span id="current-value">0.00</span></div>
                    </div>
                    <div class="bg-gray-700/50 p-3 rounded-lg border border-gray-600 col-span-2">
                        <div class="text-xs text-gray-400">Realized P&L (Booked)</div>
                        <div class="text-lg font-bold text-white">₹<span id="realized-pnl">0.00</span></div>
                    </div>
                </div>

                <!-- Unrealized P&L -->
                <div class="flex justify-between items-center bg-gray-900 p-3 rounded-lg border border-gray-700">
                    <span class="text-sm text-gray-400">Unrealized P&L</span>
                    <span id="total-pnl" class="text-xl font-bold text-gray-100">₹0.00</span>
                </div>
            </div>

            <!-- Holdings List -->
            <div class="flex-1 overflow-hidden flex flex-col">
                <div class="p-3 bg-gray-800/50 border-b border-gray-700 text-xs font-semibold text-gray-400">
                    YOUR HOLDINGS
                </div>
                <div id="portfolio-list" class="overflow-y-auto flex-1 p-2 space-y-2">
                    <!-- Portfolio items injected here -->
                    <div class="text-center text-gray-500 mt-10 italic text-sm">
                        Your portfolio is empty.<br>Buy stocks from the market list.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Modal (Hidden by default) -->
    <div id="trade-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-xl shadow-2xl border border-gray-600 w-96 p-6 transform transition-all scale-100">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 id="modal-title" class="text-2xl font-bold text-white">Reliance</h3>
                    <span id="modal-price" class="text-blue-400 font-mono text-lg">₹2450.00</span>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white">✕</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Quantity</label>
                    <div class="flex items-center gap-2">
                        <button onclick="adjustQty(-1)" class="w-10 h-10 rounded bg-gray-700 hover:bg-gray-600 text-xl font-bold">-</button>
                        <input type="number" id="trade-qty" value="1" min="1" class="flex-1 bg-gray-900 border border-gray-600 rounded h-10 text-center text-white focus:outline-none focus:border-blue-500">
                        <button onclick="adjustQty(1)" class="w-10 h-10 rounded bg-gray-700 hover:bg-gray-600 text-xl font-bold">+</button>
                    </div>
                </div>

                <div class="flex justify-between text-sm py-2 border-t border-gray-700">
                    <span class="text-gray-400">Total Cost</span>
                    <span id="trade-total" class="font-bold">₹0.00</span>
                </div>

                <button id="confirm-trade-btn" class="w-full py-3 rounded-lg font-bold text-white transition transform active:scale-95 bg-green-600 hover:bg-green-500 shadow-lg">
                    CONFIRM BUY
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 border-l-4 border-blue-500 text-white px-6 py-4 rounded shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        Notification
    </div>

    <!-- REPORT TEMPLATE (Hidden until download) -->
    <div id="printable-report" class="hidden fixed inset-0 z-[9999] overflow-auto bg-white text-black">
        <div class="max-w-4xl mx-auto border border-gray-300 p-10 mt-10 shadow-lg">
            <div class="border-b-2 border-black pb-4 mb-6">
                <div class="flex justify-between items-start">
                    <h1 class="text-3xl font-bold mb-2">Portfolio Performance Report</h1>
                    <div class="text-right">
                        <div class="bg-gray-100 px-3 py-1 rounded text-xs font-bold uppercase text-gray-600">NIFTY 50 SIMULATOR</div>
                    </div>
                </div>
                <div class="flex justify-between items-end mt-4">
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold">Trader Name</p>
                        <p id="print-name" class="text-2xl font-bold text-blue-800">Name</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500 uppercase font-bold">Report Date</p>
                        <p id="print-date" class="font-mono text-lg">--/--/----</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-6 mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div>
                    <p class="text-xs uppercase text-gray-500 font-bold mb-1">Wallet Balance</p>
                    <p id="print-balance" class="text-xl font-bold text-gray-800">₹0.00</p>
                </div>
                <div>
                    <p class="text-xs uppercase text-gray-500 font-bold mb-1">Total Invested</p>
                    <p id="print-invested" class="text-xl font-bold text-gray-800">₹0.00</p>
                </div>
                <div>
                    <p class="text-xs uppercase text-gray-500 font-bold mb-1">Current Asset Value</p>
                    <p id="print-current" class="text-xl font-bold text-gray-800">₹0.00</p>
                </div>
                <div>
                    <p class="text-xs uppercase text-gray-500 font-bold mb-1">Unrealized Net P&L</p>
                    <p id="print-pnl" class="text-xl font-bold">₹0.00</p>
                </div>
            </div>

            <h2 class="text-lg font-bold mb-4 border-l-4 border-blue-600 pl-3">Holdings Breakdown</h2>
            <table class="w-full text-left border-collapse text-sm">
                <thead>
                    <tr class="bg-gray-100 border-b border-gray-300">
                        <th class="p-3 font-semibold text-gray-700">Company</th>
                        <th class="p-3 font-semibold text-gray-700 text-right">Qty</th>
                        <th class="p-3 font-semibold text-gray-700 text-right">Avg Price</th>
                        <th class="p-3 font-semibold text-gray-700 text-right">Current Price</th>
                        <th class="p-3 font-semibold text-gray-700 text-right">Invested Amt</th>
                        <th class="p-3 font-semibold text-gray-700 text-right">Current Val</th>
                        <th class="p-3 font-semibold text-gray-700 text-right">Profit / Loss</th>
                    </tr>
                </thead>
                <tbody id="print-table-body">
                    <!-- Rows injected via JS -->
                </tbody>
            </table>
            
            <div class="mt-8 pt-4 border-t border-gray-200 flex justify-between text-xs text-gray-400">
                <span>Generated by NIFTY 50 Trader Simulator</span>
                <span>End of Report</span>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const STOCK_DATA = [
            { symbol: "RELIANCE", name: "Reliance Industries", price: 2345.50 },
            { symbol: "TCS", name: "Tata Consultancy Svcs", price: 3450.20 },
            { symbol: "HDFCBANK", name: "HDFC Bank Ltd", price: 1540.00 },
            { symbol: "ICICIBANK", name: "ICICI Bank Ltd", price: 940.75 },
            { symbol: "INFY", name: "Infosys Limited", price: 1420.30 },
            { symbol: "ITC", name: "ITC Limited", price: 445.60 },
            { symbol: "SBIN", name: "State Bank of India", price: 580.90 },
            { symbol: "BHARTIARTL", name: "Bharti Airtel", price: 870.10 },
            { symbol: "KOTAKBANK", name: "Kotak Mahindra Bank", price: 1850.40 },
            { symbol: "LT", name: "Larsen & Toubro", price: 2650.00 },
            { symbol: "HINDUNILVR", name: "Hindustan Unilever", price: 2540.00 },
            { symbol: "AXISBANK", name: "Axis Bank Ltd", price: 980.50 },
            { symbol: "BAJFINANCE", name: "Bajaj Finance", price: 7100.00 },
            { symbol: "ASIANPAINT", name: "Asian Paints", price: 3200.00 },
            { symbol: "MARUTI", name: "Maruti Suzuki", price: 9600.00 },
            { symbol: "TITAN", name: "Titan Company", price: 2950.00 },
            { symbol: "ULTRACEMCO", name: "UltraTech Cement", price: 8200.00 },
            { symbol: "SUNPHARMA", name: "Sun Pharma", price: 1120.00 },
            { symbol: "WIPRO", name: "Wipro Limited", price: 410.50 },
            { symbol: "TATAMOTORS", name: "Tata Motors", price: 620.00 },
        ];

        let state = {
            stocks: [],
            portfolio: {}, // Key: Symbol, Value: { qty, avgPrice }
            balance: 0.00,
            realizedPnL: 0.00, // Tracks profit/loss from sold stocks
            activeTrade: null
        };

        // --- INITIALIZATION ---
        function init() {
            state.stocks = STOCK_DATA.map(s => ({
                ...s,
                basePrice: s.price,
                prevPrice: s.price,
                change: 0
            }));
            
            renderStockList();
            updatePortfolioUI();
            
            // Start the Market Simulator Loop
            setInterval(simulateMarket, 3000); 
        }

        // --- MARKET SIMULATION ---
        function simulateMarket() {
            state.stocks.forEach(stock => {
                stock.prevPrice = stock.price;
                const volatility = 0.015; 
                const move = (Math.random() - 0.5) * 2 * volatility;
                stock.price = stock.price * (1 + move);
                stock.change = ((stock.price - stock.basePrice) / stock.basePrice) * 100;
            });
            renderStockList();
            updatePortfolioUI(); 
        }

        // --- RENDERING ---
        function renderStockList() {
            const container = document.getElementById('stock-list');
            container.innerHTML = '';

            state.stocks.forEach(stock => {
                const colorClass = stock.price > stock.prevPrice ? 'text-green-400' : (stock.price < stock.prevPrice ? 'text-red-400' : 'text-gray-300');
                const changeColor = stock.change >= 0 ? 'text-green-500' : 'text-red-500';
                const bgFlash = stock.price > stock.prevPrice ? 'bg-green-900/10' : (stock.price < stock.prevPrice ? 'bg-red-900/10' : '');

                // Check for holdings to display badge
                const holding = state.portfolio[stock.symbol];
                const qtyBadge = (holding && holding.qty > 0) 
                    ? `<span class="ml-2 bg-blue-900 text-blue-200 border border-blue-700 text-[10px] px-1.5 py-0.5 rounded font-mono">Qty: ${holding.qty}</span>` 
                    : '';

                const el = document.createElement('div');
                el.className = `grid grid-cols-12 gap-4 p-4 border-b border-gray-800 hover:bg-gray-800 transition items-center ${bgFlash}`;
                el.innerHTML = `
                    <div class="col-span-4 flex items-center">
                        <div>
                            <div class="font-bold text-sm text-white flex items-center">
                                ${stock.symbol}
                                ${qtyBadge}
                            </div>
                            <div class="text-xs text-gray-500 truncate">${stock.name}</div>
                        </div>
                    </div>
                    <div class="col-span-3 text-right font-mono ${colorClass}">
                        ₹${stock.price.toFixed(2)}
                    </div>
                    <div class="col-span-2 text-right text-xs font-mono ${changeColor}">
                        ${stock.change > 0 ? '+' : ''}${stock.change.toFixed(2)}%
                    </div>
                    <div class="col-span-3 flex justify-center gap-2">
                        <button onclick="openTradeModal('${stock.symbol}', 'BUY')" class="bg-green-600/20 hover:bg-green-600 border border-green-600/50 text-green-400 hover:text-white text-xs px-3 py-1 rounded transition">Buy</button>
                        <button onclick="openTradeModal('${stock.symbol}', 'SELL')" class="bg-red-600/20 hover:bg-red-600 border border-red-600/50 text-red-400 hover:text-white text-xs px-3 py-1 rounded transition">Sell</button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function updatePortfolioUI() {
            document.getElementById('wallet-balance').innerText = state.balance.toLocaleString('en-IN', {minimumFractionDigits: 2});
            document.getElementById('realized-pnl').innerText = (state.realizedPnL >= 0 ? '+' : '') + state.realizedPnL.toLocaleString('en-IN', {minimumFractionDigits: 2});
            document.getElementById('realized-pnl').className = `text-lg font-bold ${state.realizedPnL >= 0 ? 'text-green-400' : 'text-red-400'}`;

            const list = document.getElementById('portfolio-list');
            let totalInvested = 0;
            let currentValue = 0;
            let hasHoldings = false;

            list.innerHTML = ''; 

            Object.keys(state.portfolio).forEach(symbol => {
                const holding = state.portfolio[symbol];
                if (holding.qty > 0) {
                    hasHoldings = true;
                    const stock = state.stocks.find(s => s.symbol === symbol);
                    const currentVal = stock.price * holding.qty;
                    const investedVal = holding.avgPrice * holding.qty;
                    const pnl = currentVal - investedVal;
                    const pnlPercent = (pnl / investedVal) * 100;
                    
                    totalInvested += investedVal;
                    currentValue += currentVal;

                    const pnlClass = pnl >= 0 ? 'text-green-400' : 'text-red-400';

                    const item = document.createElement('div');
                    item.className = "bg-gray-800 p-3 rounded border border-gray-700 hover:border-gray-500 transition";
                    item.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-sm">${symbol}</span>
                            <span class="text-xs bg-gray-700 px-2 py-0.5 rounded text-gray-300">Qty: ${holding.qty}</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>Avg: ₹${holding.avgPrice.toFixed(2)}</span>
                            <span>LTP: ₹${stock.price.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t border-gray-700 mt-2">
                            <span class="text-xs text-gray-500">Unrealized P&L</span>
                            <div class="text-right">
                                <span class="block font-bold ${pnlClass}">₹${pnl.toFixed(2)}</span>
                                <span class="text-[10px] ${pnlClass}">(${pnlPercent.toFixed(2)}%)</span>
                            </div>
                        </div>
                    `;
                    list.appendChild(item);
                }
            });

            if (!hasHoldings) {
                list.innerHTML = `<div class="text-center text-gray-600 mt-10 italic text-sm">Your portfolio is empty.<br>Buy stocks from the market list.</div>`;
            }

            const totalPnl = currentValue - totalInvested;
            const totalPnlClass = totalPnl >= 0 ? 'text-green-400' : 'text-red-400';

            document.getElementById('total-invested').innerText = totalInvested.toLocaleString('en-IN', {minimumFractionDigits: 2});
            document.getElementById('current-value').innerText = currentValue.toLocaleString('en-IN', {minimumFractionDigits: 2});
            
            const pnlEl = document.getElementById('total-pnl');
            pnlEl.innerText = (totalPnl >= 0 ? '+' : '') + "₹" + totalPnl.toLocaleString('en-IN', {minimumFractionDigits: 2});
            pnlEl.className = `text-xl font-bold ${totalPnlClass}`;
        }

        // --- PRINT / DOWNLOAD FUNCTIONALITY ---
        function downloadPDF() {
            // Populate Print Data
            const name = document.getElementById('trader-name').value || "Guest Trader";
            document.getElementById('print-name').innerText = name;
            document.getElementById('print-date').innerText = new Date().toLocaleString();
            document.getElementById('print-balance').innerText = document.getElementById('wallet-balance').innerText;
            
            // Calculate totals for report
            let totalInvested = 0;
            let totalCurrent = 0;
            const tbody = document.getElementById('print-table-body');
            tbody.innerHTML = '';

            Object.keys(state.portfolio).forEach(symbol => {
                const holding = state.portfolio[symbol];
                if (holding.qty > 0) {
                    const stock = state.stocks.find(s => s.symbol === symbol);
                    const currentVal = stock.price * holding.qty;
                    const investedVal = holding.avgPrice * holding.qty;
                    const pnl = currentVal - investedVal;
                    
                    totalInvested += investedVal;
                    totalCurrent += currentVal;

                    const pnlColor = pnl >= 0 ? 'text-green-700' : 'text-red-700';

                    tbody.innerHTML += `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="p-3 font-bold">${symbol} <span class="text-xs font-normal text-gray-500 block">${stock.name}</span></td>
                            <td class="p-3 text-right">${holding.qty}</td>
                            <td class="p-3 text-right">₹${holding.avgPrice.toFixed(2)}</td>
                            <td class="p-3 text-right">₹${stock.price.toFixed(2)}</td>
                            <td class="p-3 text-right">₹${investedVal.toFixed(2)}</td>
                            <td class="p-3 text-right">₹${currentVal.toFixed(2)}</td>
                            <td class="p-3 text-right font-bold ${pnlColor}">₹${pnl.toFixed(2)}</td>
                        </tr>
                    `;
                }
            });

            if (Object.keys(state.portfolio).length === 0 || totalInvested === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-gray-500 italic">No active holdings to report.</td></tr>`;
            }

            const totalPnl = totalCurrent - totalInvested;
            
            document.getElementById('print-invested').innerText = "₹" + totalInvested.toLocaleString('en-IN', {minimumFractionDigits: 2});
            document.getElementById('print-current').innerText = "₹" + totalCurrent.toLocaleString('en-IN', {minimumFractionDigits: 2});
            
            const pnlEl = document.getElementById('print-pnl');
            pnlEl.innerText = (totalPnl >= 0 ? '+' : '') + "₹" + totalPnl.toLocaleString('en-IN', {minimumFractionDigits: 2});
            pnlEl.className = `text-xl font-bold ${totalPnl >= 0 ? 'text-green-700' : 'text-red-700'}`;

            // PDF Generation Logic
            const element = document.getElementById('printable-report');
            element.classList.remove('hidden'); // Make visible for capture

            const opt = {
                margin:       0.5,
                filename:     `Portfolio_Report_${new Date().toISOString().split('T')[0]}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            showToast("Generating PDF...", "success");

            // Use html2pdf library
            html2pdf().set(opt).from(element).save().then(() => {
                element.classList.add('hidden'); // Hide again
                showToast("PDF Downloaded!", "success");
            });
        }

        // --- TRADING LOGIC ---
        function addFunds() {
            const input = document.getElementById('fund-amount');
            const amount = parseFloat(input.value);
            
            if (isNaN(amount) || amount <= 0) {
                showToast("Please enter a valid amount", "error");
                return;
            }

            state.balance += amount;
            showToast(`Added ₹${amount.toLocaleString()} to Wallet`, 'success');
            input.value = ''; // Clear input
            updatePortfolioUI();
        }

        function openTradeModal(symbol, type) {
            const stock = state.stocks.find(s => s.symbol === symbol);
            state.activeTrade = { symbol, type, stock };
            
            const modal = document.getElementById('trade-modal');
            const btn = document.getElementById('confirm-trade-btn');
            
            document.getElementById('modal-title').innerText = `${type} ${symbol}`;
            document.getElementById('modal-price').innerText = `₹${stock.price.toFixed(2)}`;
            document.getElementById('trade-qty').value = 1;

            if (type === 'BUY') {
                btn.innerText = "CONFIRM BUY";
                btn.className = "w-full py-3 rounded-lg font-bold text-white transition transform active:scale-95 bg-green-600 hover:bg-green-500 shadow-lg";
            } else {
                btn.innerText = "CONFIRM SELL";
                btn.className = "w-full py-3 rounded-lg font-bold text-white transition transform active:scale-95 bg-red-600 hover:bg-red-500 shadow-lg";
            }
            
            updateTradeTotal();
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('trade-modal').classList.add('hidden');
            state.activeTrade = null;
        }

        function adjustQty(delta) {
            const input = document.getElementById('trade-qty');
            let val = parseInt(input.value) + delta;
            if (val < 1) val = 1;
            input.value = val;
            updateTradeTotal();
        }

        function updateTradeTotal() {
            if (!state.activeTrade) return;
            const qty = parseInt(document.getElementById('trade-qty').value);
            const total = qty * state.activeTrade.stock.price;
            document.getElementById('trade-total').innerText = `₹${total.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
        }

        document.getElementById('trade-qty').addEventListener('input', updateTradeTotal);

        document.getElementById('confirm-trade-btn').onclick = function() {
            if (!state.activeTrade) return;
            
            const { symbol, type, stock } = state.activeTrade;
            const qty = parseInt(document.getElementById('trade-qty').value);
            const totalCost = qty * stock.price;

            if (type === 'BUY') {
                if (state.balance >= totalCost) {
                    state.balance -= totalCost;
                    if (!state.portfolio[symbol]) {
                        state.portfolio[symbol] = { qty: 0, avgPrice: 0 };
                    }
                    const holding = state.portfolio[symbol];
                    const oldCost = holding.qty * holding.avgPrice;
                    const newCost = oldCost + totalCost;
                    const newQty = holding.qty + qty;
                    holding.avgPrice = newCost / newQty;
                    holding.qty = newQty;

                    showToast(`Bought ${qty} ${symbol} @ ₹${stock.price.toFixed(2)}`, 'success');
                    closeModal();
                } else {
                    showToast("Insufficient Funds!", 'error');
                }
            } else if (type === 'SELL') {
                const holding = state.portfolio[symbol];
                if (holding && holding.qty >= qty) {
                    // Logic for Selling
                    state.balance += totalCost;
                    holding.qty -= qty;
                    
                    // Calculate Realized PnL for this specific trade
                    const buyPriceForTheseShares = holding.avgPrice * qty;
                    const sellPriceForTheseShares = totalCost; // Current Price * qty
                    const tradePnL = sellPriceForTheseShares - buyPriceForTheseShares;
                    
                    state.realizedPnL += tradePnL;

                    if (holding.qty === 0) delete state.portfolio[symbol];
                    
                    const pnlText = tradePnL >= 0 ? `Profit: +₹${tradePnL.toFixed(2)}` : `Loss: -₹${Math.abs(tradePnL).toFixed(2)}`;
                    const toastType = tradePnL >= 0 ? 'success' : 'error'; // Error style for Loss (Red)

                    showToast(`Sold ${qty} ${symbol}. ${pnlText}`, toastType);
                    closeModal();
                } else {
                    showToast("Insufficient Holdings!", 'error');
                }
            }
            updatePortfolioUI();
            renderStockList(); // Instant UI Update
        };

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.className = `fixed bottom-5 right-5 px-6 py-4 rounded shadow-2xl transform transition-all duration-300 z-50 text-white font-semibold border-l-4 ${type === 'error' ? 'bg-gray-800 border-red-500' : 'bg-gray-800 border-green-500'}`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        init();
    </script>
</body>
</html>